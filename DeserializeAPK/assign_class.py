import pandas as pd
import os

def retrieve_families():
    f = open('families.txt', 'r')
    families = f.readlines()
    fam = []
    for elem in families:
        fam.append(elem.replace('\n', ''))
        if len(fam) == 123:
            break
    return fam

def retrieve_classes(fam):
    c = open('classi2.txt', 'r')
    classi = c.readlines()
    cla = []
    for e in classi:
        cla.append(e.replace('\n', ''))
    complete = dict(zip(fam, cla))
    return complete

def adjust_drebin():
    drebin = open('hashes_256', 'a')
    csv = pd.read_excel('madam_malware_android_dataset.xlsx')
    fam_csv = csv['MADAM Android Malware Dataset']
    hash_csv = csv['Unnamed: 1']
    for h in hash_csv:
        drebin.write(str(h)[1:] + '\n')

    hash_class = dict(zip(hash_csv, fam_csv))
    return hash_csv,hash_class

def set_definitive_hash_dict(complete, hash_csv, hash_class):
    hash_definitive = {}
    for h in hash_csv:
        try:
            hash_definitive[h] = complete[hash_class[h]]
        except:
            pass
    return hash_definitive
    
def assign_class(hash_definitive):
    complete_files = _handle_files(hash_definitive)
    DEFINITIVE = {}
    for file in complete_files:
        try:
            DEFINITIVE[file] = hash_definitive[' ' + str(file)]
        except Exception as e:
            pass
    return DEFINITIVE

def _handle_files(hash_definitive):
    w = open('DREBIN_DEFINITIVE', 'w')
    w.write(str(hash_definitive))
    path = ""
    folders = os.listdir(path)    
    complete_files = []
    for folder in folders:
        print('sono qui')
        print(folder)
        files = os.listdir(path)
        for file in files:
            complete_files.append(file)
    return complete_files

def main(hash_definitive, assign_class):
    DEFINITIVE = assign_class(hash_definitive)
    with open('FINAL_DREBIN_CLASSIFIED', 'w') as f:
        f.write(str(DEFINITIVE))
    return DEFINITIVE

def check(DEFINITIVE):
    path = ""
    folders = os.listdir(path)    
    no_listed_files = []
    for folder in folders:
        files = os.listdir(path + folder )
        for file in files:
            try:
                print(DEFINITIVE[file])
            except:
                no_listed_files.append(file)
    return no_listed_files

if __name__ == '__main__':
    fam = retrieve_families()
    print("Families retrieved")
    complete = retrieve_classes(fam)
    print("Classes retrieved")
    hash_csv, hash_class = adjust_drebin()
    print("Drebin adjusted")
    hash_definitive = set_definitive_hash_dict(complete, hash_csv, hash_class)
    print("Definitive hash dictionary set")
    DEFINITIVE = main(hash_definitive, assign_class)
    print("Classes assigned")
    no_listed_files =check(DEFINITIVE)
    print("No listed files retrieved") 
    with open('NO_LISTED_APKs.txt', 'a') as n:
        for file in no_listed_files:
            n.write(file + '\n')
